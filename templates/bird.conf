# {{ conf }}
# This file was automatically generated by l3overlayd.

log "{{ log }}" all;

{% if log_level == "DEBUG" %}
debug protocols all;
{% endif %}

router id {{ mesh_tunnels[0].virtual_local }};

protocol device
{
}

protocol kernel
{
    export all;
}

protocol bfd
{
}

protocol direct
{

{% if dummies|length > 0 %}
    # Static dummies
{% for dummy in dummies %}
    interface "{{ dummy.dummy_name }}";
{% endfor %}
{% endif %}

{% if overlay_links|length > 0 %}
    # Static overlay links
{% for overlay_link in overlay_links %}
{% if overlay == overlay_link.outer_overlay_name %}
    interface "{{ overlay_link.bridge_name }}";
{% else %}
    interface "{{ overlay_link.inner_name }}";
{% endif %}
{% endfor %}
{% endif %}

{% if tunnels|length > 0 %}
    # Static tunnels
{% for tunnel in tunnels %}
    interface "{{ tunnel.tunnel_name }}";
{% endfor %}
{% endif %}

{% if tuntaps|length > 0 %}
    # Static TUNs/TAPs
{% for tuntap in tuntaps %}
    interface "{{ tuntap.tuntap_name }}";
{% endfor %}
{% endif %}

{% if veths|length > 0 %}
    # Static veths
{% for veth in veths %}
    interface "{{ veth.outer_name }}";
{% endfor %}
{% endif %}

{% if vlans|length > 0 %}
    # Static VLANs
{% for vlan in vlans %}
    interface "{{ vlan.vlan_name }}";
{% endfor %}
{% endif %}

}

# Mesh tunnels
{% for mesh_tunnel in mesh_tunnels %}
protocol bgp '{{ mesh_tunnel.name }}'
{

    import all;
    export all;

    direct;
    next hop self;

    bfd on;
    ttl security on;

    local {{ mesh_tunnel.virtual_local }} as {{ asn }};
    neighbor {{ mesh_tunnel.virtual_remote }} as {{ asn }};

    description "{{ mesh_tunnel.node_local }} -> {{ mesh_tunnel.node_remote }}";

}

{% endfor %}

{% if overlay_links|length > 0 %}
{% for overlay_link in overlay_links %}
# Static overlay link
protocol bgp '{{ overlay_link.name }}'
{

    import all;
    export all;

    direct;
    next hop self;

    bfd on;
    ttl security on;

{% if overlay == overlay_link.outer_overlay_name %}
    local {{ overlay_link.outer_address }} as {{ overlay_link.outer_asn }};
    neighbor {{ overlay_link.inner_address }} as {{ overlay_link.inner_asn }};
    description "{{ overlay_link.outer_overlay_name }} -> {{ overlay_link.inner_overlay_name }}";
{% else %}
    local {{ overlay_link.inner_address }} as {{ overlay_link.inner_asn }};
    neighbor {{ overlay_link.outer_address }} as {{ overlay_link.outer_asn }};
    description "{{ overlay_link.inner_overlay_name }} -> {{ overlay_link.outer_overlay_name }}";
{% endif %}
}

{% endfor %}
{% endif %}

{% if bgps|length > 0 %}
{% for bgp in bgps %}
# Static BGP protocol
protocol bgp '{{ bgp.name }}'
{

    direct;
    next hop self;

    bfd {{ "on" if bgp.bfd else "off" }};
    ttl security {{ "on" if bgp.ttl_security else "off" }};

    local {% if bgp.local %}{{ bgp.local }} {% endif %}as {{ bgp.local_asn }};
    neighbor {{ bgp.neighbor }} as {{ bgp.neighbor_asn }};

{% if bgp.description %}
    description "{{ bgp.description }}";
{% endif %}

    import filter {
{% if bgp.import_prefixes %}

        if net ~ [ {{ bgp.import_prefixes|join(", ") }} ] then
            reject;
{% endif %}

        if (24226, 900) ~ bgp_community then
            reject;

        accept;

    };

    export filter {

        bgp_community.add((24226, 900));
        accept;

    };

}

{% endfor %}
{% endif %}
